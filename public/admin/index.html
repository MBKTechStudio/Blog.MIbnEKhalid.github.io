<!--
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/css/intlTelInput.css">
    <link rel="stylesheet" href="https://mbktechstudio.com/Assets/style.css"> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" />
--> 
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" />
    <link rel="icon" type="image/x-icon" href="https://mbktechstudio.com/Assets/Images/dgicon.svg">
    <title>Admin Panel / Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        async function fetchDeployStatus() {
            const siteId = process.env.NetlifySiteIDblogMBK || 'ef4c0a19-ca35-467d-852f-8652cd8d9ccf';
            const accessToken = process.env.NetlifyAPIkeyTest || 'nfp_s832HAemYa2E1uay3rK1Cb8jRARgkNuo99b1';

            try {
                const response = await fetch(`https://api.netlify.com/api/v1/sites/${siteId}/deploys`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }

                const deploys = await response.json();
                const latestDeploy = deploys[0];

                if (latestDeploy) {
                    const latestDeployState = latestDeploy.state || 'No deployment found';
                    const deployTime = new Date(latestDeploy.created_at).toLocaleString();

                    document.getElementById('deployStatus').innerText =
                        `Deployment Status: ${latestDeployState}\nDeployed at: ${deployTime}`;

                    // Fetch the latest commit from GitHub
                    await fetchLatestCommitTime(); // Corrected function call
                } else {
                    document.getElementById('deployStatus').innerText = 'No deployment found';
                }

            } catch (error) {
                document.getElementById('deployStatus').innerText = `Error: ${error.message}`;
            }
        }

        async function fetchLatestCommitTime() {
            const owner = 'MIbnEKhalid'; // Your GitHub username or organization name
            const repo = 'Blog.MIbnEKhalid.github.io'; // Your repository name
            const branch = 'main'; // The branch you want, e.g., 'main'

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/commits?sha=${branch}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json'
                        // If you have a GitHub token, you can add an Authorization header
                        // 'Authorization': `Bearer YOUR_GITHUB_TOKEN`
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }

                const commitData = await response.json();

                // Get the latest commit
                const latestCommit = commitData[0]; // Latest commit
                const commitTime = new Date(latestCommit.commit.committer.date).toLocaleString();
                const commitMessage = latestCommit.commit.message;

                document.getElementById('commitTime').innerText = `Latest Commit Time: ${commitTime}`;
                document.getElementById('commitMessage').innerText = `Commit Message: ${commitMessage}`;
            } catch (error) {
                document.getElementById('commitTime').innerText = `Error: ${error.message}`;
                document.getElementById('commitMessage').innerText = '';
            }
        }

        function checkUserLogin() {
            const user = netlifyIdentity.currentUser();
            const deployInfoDiv = document.getElementById("deployInfo");

            if (user) {
                // User is logged in, hide deployInfo
                if (deployInfoDiv) {
                    deployInfoDiv.style.display = "none";
                }
            } else {
                // User is not logged in, show deployInfo
                if (deployInfoDiv) {
                    deployInfoDiv.style.display = "block";
                }
            }
        }

        // Event listener for Netlify Identity login/logout events
        netlifyIdentity.on("login", checkUserLogin);
        netlifyIdentity.on("logout", checkUserLogin);

        // Call these functions to fetch and display data
        window.onload = function () {
            fetchDeployStatus();
            fetchLatestCommitTime();
            checkUserLogin();

            document.getElementById("relAPI").onclick = async function () {
                console.log('Reloading APIs');
                await fetchDeployStatus();
                await fetchLatestCommitTime();
            };
        };
    </script>  
</head>

<body>

    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <div class="deployInfo" id="deployInfo">
        
        <h1>Netlify Deployment Status</h1>
        <p id="deployStatus">Loading...</p>
      
        <h1>GitHub Commit Status</h1>
        <p id="commitTime">Loading latest commit time...</p>
        <p id="commitMessage">Loading commit message...</p>  

        <button class="relAPI" id="relAPI">Reload API</button>

        This section contains a list of Netlify Deployment Statuses and their corresponding descriptions:
        <ul class="status-list">
            <li>new = Project Deployment Is triggered and new deployment is added</li>
            <li>enqueued = Deployment Is Starting Up</li>
            <li>building = Project Is Building</li>
            <li>error = Project Build Failed</li>
            <li>ready = Project Build Successfull and site is Published</li>
        </ul>

    </div>



    <div id="deployInfo1">  </div>
</body>
<script>
    async function fetchAndDisplayHTML() {
        try {
            const response = await fetch('info.html');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const htmlContent = await response.text();
            document.getElementById('deployInfo1').innerHTML = htmlContent;
        } catch (error) {
            console.error('There has been a problem with your fetch operation:', error);
        }
    }

    // Call the function to fetch and display the HTML content
    fetchAndDisplayHTML();
</script>
</html>
</body>

</html> 